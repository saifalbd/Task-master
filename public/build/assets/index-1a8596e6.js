import{A as H,_ as F,y as N,m as O,r as U,g as j,h as I,i as v,j as p,o as S,a as l,k as m,e as R,c as T,l as z,F as q,t as C,s as K,b as P,v as W,O as Z,x as G}from"./app-ec84c5d3.js";import{A as J,P as Q,c as X}from"./PageTitleBox-ebdb7c37.js";import{e as i,m as b,u as Y,i as x}from"./icon-c404ea0d.js";class M{constructor(t){this.chat=t,this.isSend=t.isSend,this.isHover=!1;let o=i("span",`${this.isSend?"Send":"Recieve"}: ${t.message}`);this.chatRow=i(".chat-row",{},[this.fileBox(t),o]),this.el=i("li",{},[this.chatRow]),this.isSend&&this.el.classList.add("right")}fileBox(t){if(t.attach){let o=t.attach;return o.isImg?i("img",{src:t.attach.url}):i("a",{href:o.url},`${o.url}`)}else return i("span")}onmount(){const{id:t,is_view:o,message:a}=this.chat;window.Echo.private(`chatread.${t}`).listen("ChatReadEvent",h=>{let r=this.chatRow.querySelector(".chat-row-icon");r&&r.remove(),b(this.chatRow,i("span",{class:"chat-row-icon"},[x.create(x.dobbleCheck,18)]))}),this.isSend?o!=null&&(o?b(this.chatRow,i("span",{class:"chat-row-icon"},[x.create(x.dobbleCheck,18)])):b(this.chatRow,i("span",{class:"chat-row-icon"},[x.create(x.check,18)]))):this.el.addEventListener("mouseover",()=>{this.isHover||(o||window.axios.put(route("chat.read",{chat:t}),{}),this.isHover=!0)})}}class ${constructor(){this.el=i("ul",{class:"chat-content"}),this.list=[]}pushCollection(t){t.forEach(o=>{let a=new M(o);this.list.push(a),b(this.el,a)})}push(t){let o=new M(t);this.list.push(o),b(this.el,o)}removeCollection(){this.list.forEach(t=>{Y(this.el,t)})}scrollToBottom(){let t=this.list.at(-1);t&&t.el.scrollIntoView()}}class tt{constructor(t,o,a,h,r){this.parentDom=t,this.src=o,this.file=a,this.captionText="",this.callBack=h,this.isImg=r,this.attachIcon="M16.61 13.5C15.81 13.85 15.11 14.36 14.54 15H9.5C8.12 15 7 13.88 7 12.5S8.12 10 9.5 10H17V11.5H9.5C8.95 11.5 8.5 11.95 8.5 12.5S8.95 13.5 9.5 13.5H16.61M3.5 12.5C3.5 10.29 5.29 8.5 7.5 8.5H18C19.38 8.5 20.5 9.62 20.5 11C20.5 11.84 20.08 12.58 19.45 13.03C20.05 13.07 20.63 13.2 21.17 13.41C21.69 12.74 22 11.91 22 11C22 8.79 20.21 7 18 7H7.5C4.46 7 2 9.46 2 12.5S4.46 18 7.5 18H13.09C13.18 17.47 13.34 16.97 13.55 16.5H7.5C5.29 16.5 3.5 14.71 3.5 12.5M21.34 15.84L17.75 19.43L16.16 17.84L15 19L17.75 22L22.5 17.25L21.34 15.84Z",this.el=i(".attach-model",{},[i(".attach-card",{},[this.close(),this.file_box(),this.captionBox(),this.sendBox()])])}close(){let t=i("div",{class:"close-box"},[x.create(x.close)]);return t.addEventListener("click",()=>{this.el.remove()}),t}file_box(){let t=i("div",{},[i("div",{style:`height: 100px;
                width: 100px;
                display: flex;
                justify-content: center;
                align-items: center;`},[x.create(this.attachIcon,50)]),i("p",{},this.src),i("div",{},`Size:${this.file.size}`)]),o=this.isImg?i("img",{src:this.src}):t;return i(".file_box",{},[o])}captionBox(){let t=i("input",{placeholder:"Caption"});return t.addEventListener("change",o=>{let a=t.value;this.captionText=a}),i("div",{class:"caption-box"},[t])}sendBox(){let t=i("button","send");return t.addEventListener("click",()=>{const o=this.captionText;this.callBack(o,this.file),this.el.remove()}),i(".send-box",{},[t])}}const D=(c,t,o,a)=>{let h=document.getElementById("chatMainBar");b(h,new tt(h,c,t,o,a))},et=c=>{let t=c.type;return console.log({type:t}),H.startsWith(t,"image")},st=(c,t)=>{try{let a=c.target.files;if(a.length){let h=a[0],r=et(h);console.log({isImg:r});const y=document.getElementById("attachBox"),u=V(t);if(y.removeChild(y.querySelector("input")),setTimeout(()=>{b(y,u)},3e3),r){let f=new FileReader;f.onload=function(){let d=f.result;D(d,h,t,r)},f.readAsDataURL(h)}else D(h.name,h,t,r)}}catch(o){console.error(o)}},V=c=>{let t=i("input",{class:"attach-input",type:"file"},[]);return t.addEventListener("change",o=>{st(o,c)}),t},ot={components:{AppLayout:J,PageTitleBox:Q},setup(){const c=X(),t=N(()=>c.users),o=O(),a=Echo.join("chat").joining(e=>{axios.put(route("online",{user:e.id}))}).leaving(e=>{axios.put(route("offline",{user:e.id}),{})});(()=>{try{a.listen("UserOnline",e=>{E(e.id,1)}).listen("UserOffline",e=>{E(e.id,0)}).listen("ChatEvent",e=>{const s=e.sender_id,n=u.value.id;if(console.log({sender_id:s,current_id:n,auth_id:r}),s!=r)if(n==s){let _=g(e);d.push(_),d.scrollToBottom()}else c.increaseUnread(e.sender_id,1)})}catch(e){console.error(e)}})();const r=o.auth_id,y=U(!1),u=U(null),f=U(""),d=new $,g=e=>{const{sender_id:s,receiver_id:n}=e;return r==s?e.isSend=!0:e.isSend=!1,e},w=async()=>{let e=H.trim(f.value);try{if(!e)throw"message are Empty";if(!u)throw"current user not found";const s=route("chat.store"),{data:n}=await axios.post(s,{receiver_id:u.value.id,message:e});d.push(g(n)),d.scrollToBottom(),f.value=""}catch(s){console.error(s)}},B=async e=>{let s=u.value;if(s&&s.id==e.id)return null;d.removeCollection(),u.value=e,t.value.forEach(n=>n.active=!1),e.active=!0;try{const n=route("chat.index",{receiver_id:e.id}),{data:_}=await axios.get(n);let k=_.map(A=>g(A));b(document.getElementById("chatMainBar"),d),d.pushCollection(k),d.scrollToBottom()}catch(n){console.error(n)}},E=(e,s)=>{const n=t.value.find(_=>_.id==e);n&&(n.isOnline=!!s)},L=async(e,s)=>{try{if(!u.value)throw new Error("CurrentUser Not Found");const n=route("chat.store"),_=new FormData;_.append("message",e),_.append("receiver_id",u.value.id),_.append("file",s);const{data:k}=await axios.post(n,_);d.push(g(k)),d.scrollToBottom()}catch(n){console.error(n)}};return j(()=>{c.fetchChatUsers(e=>{let s=H.head(e);s&&B(s)}),b(document.getElementById("attachBox"),V(L))}),{busy:y,users:t,currentUser:u,chatHistory:B,text:f,send:w}}},at={class:"chat-layout"},it={class:"chat-side-bar"},nt={class:"chat-main-bar",id:"chatMainBar"},lt={key:0,class:"current-info"},ct={class:"left"},rt={class:"avatar-box"},dt=["src"],ht={class:"name"},ut={class:"position"},mt={class:"input-box"},_t={class:"attach-box",id:"attachBox"};function vt(c,t,o,a,h,r){const y=p("page-title-box"),u=p("va-list-label"),f=p("va-avatar"),d=p("va-badge"),g=p("va-list-item-section"),w=p("va-list-item-label"),B=p("va-list-item"),E=p("va-list"),L=p("va-icon"),e=p("app-layout");return S(),I(e,{busy:a.busy},{default:v(()=>[l("div",null,[m(y,{title:"Chats"})]),l("div",at,[l("div",it,[m(E,null,{default:v(()=>[m(u,{class:"mb-3"},{default:v(()=>[R(" Contacts ")]),_:1}),(S(!0),T(q,null,z(a.users,(s,n)=>(S(),I(B,{class:G({list__item:!0,active:s.active}),key:n,disabled:!1,onClick:_=>a.chatHistory(s)},{default:v(()=>[m(g,{avatar:""},{default:v(()=>[m(d,{dot:"",color:s.isOnline?"success":"secondary"},{default:v(()=>[m(f,{size:"small"})]),_:2},1032,["color"])]),_:2},1024),m(g,null,{default:v(()=>[m(w,null,{default:v(()=>[l("b",null,C(s.name),1)]),_:2},1024),m(w,null,{default:v(()=>[l("small",null,C(s.position),1)]),_:2},1024),m(w,{caption:""},{default:v(()=>[R(C(s.lastMessage),1)]),_:2},1024)]),_:2},1024),m(g,{icon:""},{default:v(()=>[l("b",null,C(s.unReadCount),1)]),_:2},1024)]),_:2},1032,["class","onClick"]))),128))]),_:1})]),l("div",nt,[a.currentUser?(S(),T("div",lt,[l("div",ct,[l("div",rt,[l("img",{src:a.currentUser.avatar.url,alt:"",srcset:""},null,8,dt)]),l("div",null,[l("div",ht,C(a.currentUser.name),1),l("div",ut,C(a.currentUser.position),1)])])])):K("",!0),l("div",mt,[l("div",_t,[l("button",null,[m(L,{name:"attach_file"})])]),P(l("input",{class:"text-input",type:"text","onUpdate:modelValue":t[0]||(t[0]=s=>a.text=s),onKeyup:t[1]||(t[1]=Z((...s)=>a.send&&a.send(...s),["enter"]))},null,544),[[W,a.text]]),l("button",{onClick:t[2]||(t[2]=(...s)=>a.send&&a.send(...s))},"Send")])])])]),_:1},8,["busy"])}const bt=F(ot,[["render",vt]]);export{bt as default};
