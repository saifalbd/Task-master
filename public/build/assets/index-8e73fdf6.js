import{z as I,_ as z,u as F,m as j,n as H,e as A,f as U,g as _,h as p,o as S,a as c,i as u,b as R,c as M,j as O,F as q,t as B,q as K,w as P,v as W,N as Z,s as G}from"./app-9ac6d560.js";import{A as J,P as Q,c as X}from"./PageTitleBox-2a1a7b4e.js";import{e as i,m as y,u as Y,i as x}from"./icon-c404ea0d.js";class T{constructor(t){this.chat=t,this.isSend=t.isSend,this.isHover=!1;let s=i("span",`${this.isSend?"Send":"Recieve"}: ${t.message}`);this.chatRow=i(".chat-row",{},[this.fileBox(t),s]),this.el=i("li",{},[this.chatRow]),this.isSend&&this.el.classList.add("right")}fileBox(t){if(t.attach){let s=t.attach;return s.isImg?i("img",{src:t.attach.url}):i("a",{href:s.url},`${s.url}`)}else return i("span")}onmount(){const{id:t,is_view:s,message:a}=this.chat;window.Echo.private(`chatread.${t}`).listen("ChatReadEvent",r=>{let h=this.chatRow.querySelector(".chat-row-icon");h&&h.remove(),y(this.chatRow,i("span",{class:"chat-row-icon"},[x.create(x.dobbleCheck,18)]))}),this.isSend?s!=null&&(s?y(this.chatRow,i("span",{class:"chat-row-icon"},[x.create(x.dobbleCheck,18)])):y(this.chatRow,i("span",{class:"chat-row-icon"},[x.create(x.check,18)]))):this.el.addEventListener("mouseover",()=>{this.isHover||(s||window.axios.put(route("chat.read",{chat:t}),{}),this.isHover=!0)})}}class ${constructor(){this.el=i("ul",{class:"chat-content"}),this.list=[]}pushCollection(t){t.forEach(s=>{let a=new T(s);this.list.push(a),y(this.el,a)})}push(t){let s=new T(t);this.list.push(s),y(this.el,s)}removeCollection(){this.list.forEach(t=>{Y(this.el,t)})}scrollToBottom(){let t=this.list.at(-1);t&&t.el.scrollIntoView()}}class tt{constructor(t,s,a,r,h){this.parentDom=t,this.src=s,this.file=a,this.captionText="",this.callBack=r,this.isImg=h,this.attachIcon="M16.61 13.5C15.81 13.85 15.11 14.36 14.54 15H9.5C8.12 15 7 13.88 7 12.5S8.12 10 9.5 10H17V11.5H9.5C8.95 11.5 8.5 11.95 8.5 12.5S8.95 13.5 9.5 13.5H16.61M3.5 12.5C3.5 10.29 5.29 8.5 7.5 8.5H18C19.38 8.5 20.5 9.62 20.5 11C20.5 11.84 20.08 12.58 19.45 13.03C20.05 13.07 20.63 13.2 21.17 13.41C21.69 12.74 22 11.91 22 11C22 8.79 20.21 7 18 7H7.5C4.46 7 2 9.46 2 12.5S4.46 18 7.5 18H13.09C13.18 17.47 13.34 16.97 13.55 16.5H7.5C5.29 16.5 3.5 14.71 3.5 12.5M21.34 15.84L17.75 19.43L16.16 17.84L15 19L17.75 22L22.5 17.25L21.34 15.84Z",this.el=i(".attach-model",{},[i(".attach-card",{},[this.close(),this.file_box(),this.captionBox(),this.sendBox()])])}close(){let t=i("div",{class:"close-box"},[x.create(x.close)]);return t.addEventListener("click",()=>{this.el.remove()}),t}file_box(){let t=i("div",{},[i("div",{style:`height: 100px;
                width: 100px;
                display: flex;
                justify-content: center;
                align-items: center;`},[x.create(this.attachIcon,50)]),i("p",{},this.src),i("div",{},`Size:${this.file.size}`)]),s=this.isImg?i("img",{src:this.src}):t;return i(".file_box",{},[s])}captionBox(){let t=i("input",{placeholder:"Caption"});return t.addEventListener("change",s=>{let a=t.value;this.captionText=a}),i("div",{class:"caption-box"},[t])}sendBox(){let t=i("button","send");return t.addEventListener("click",()=>{const s=this.captionText;this.callBack(s,this.file),this.el.remove()}),i(".send-box",{},[t])}}const D=(l,t,s,a)=>{let r=document.getElementById("chatMainBar");y(r,new tt(r,l,t,s,a))},et=l=>{let t=l.type;return console.log({type:t}),I.startsWith(t,"image")},st=(l,t)=>{try{let a=l.target.files;if(a.length){let r=a[0],h=et(r);console.log({isImg:h});const g=document.getElementById("attachBox"),m=V(t);if(g.removeChild(g.querySelector("input")),setTimeout(()=>{y(g,m)},3e3),h){let f=new FileReader;f.onload=function(){let d=f.result;D(d,r,t,h)},f.readAsDataURL(r)}else D(r.name,r,t,h)}}catch(s){console.error(s)}},V=l=>{let t=i("input",{class:"attach-input",type:"file"},[]);return t.addEventListener("change",s=>{st(s,l)}),t},ot={components:{AppLayout:J,PageTitleBox:Q},setup(){const l=X(),t=F(()=>l.users),s=j(),a=Echo.join("chat").joining(e=>{axios.put(route("online",{user:e.id}))}).leaving(e=>{axios.put(route("offline",{user:e.id}),{})});(()=>{try{a.listen("UserOnline",e=>{E(e.id,1)}).listen("UserOffline",e=>{E(e.id,0)}).listen("ChatEvent",e=>{if(e.sender_id!=h){let o=b(e);d.push(o)}})}catch(e){console.error(e)}})();const h=s.auth_id,g=H(!1),m=H(null),f=H(""),d=new $,b=e=>{const{sender_id:o,receiver_id:n}=e;return h==o?e.isSend=!0:e.isSend=!1,e},C=async()=>{let e=I.trim(f.value);try{if(!e)throw"message are Empty";if(!m)throw"current user not found";const o=route("chat.store"),{data:n}=await axios.post(o,{receiver_id:m.value.id,message:e});d.push(b(n)),d.scrollToBottom(),f.value=""}catch(o){console.error(o)}},w=async e=>{let o=m.value;if(o&&o.id==e.id)return null;d.removeCollection(),m.value=e,t.value.forEach(n=>n.active=!1),e.active=!0;try{const n=route("chat.index",{receiver_id:e.id}),{data:v}=await axios.get(n);let k=v.map(N=>b(N));y(document.getElementById("chatMainBar"),d),d.pushCollection(k),d.scrollToBottom()}catch(n){console.error(n)}},E=(e,o)=>{const n=t.value.find(v=>v.id==e);n&&(n.isOnline=!!o)},L=async(e,o)=>{try{if(!m.value)throw new Error("CurrentUser Not Found");const n=route("chat.store"),v=new FormData;v.append("message",e),v.append("receiver_id",m.value.id),v.append("file",o);const{data:k}=await axios.post(n,v);d.push(b(k)),d.scrollToBottom()}catch(n){console.error(n)}};return A(()=>{l.fetchChatUsers(e=>{let o=I.head(e);o&&w(o)}),y(document.getElementById("attachBox"),V(L))}),{busy:g,users:t,currentUser:m,chatHistory:w,text:f,send:C}}},at={class:"chat-layout"},it={class:"chat-side-bar"},nt={class:"chat-main-bar",id:"chatMainBar"},lt={key:0,class:"current-info"},ct={class:"left"},rt={class:"name"},ht={class:"position"},dt={class:"input-box"},ut={class:"attach-box",id:"attachBox"};function mt(l,t,s,a,r,h){const g=p("page-title-box"),m=p("va-list-label"),f=p("va-avatar"),d=p("va-badge"),b=p("va-list-item-section"),C=p("va-list-item-label"),w=p("va-icon"),E=p("va-list-item"),L=p("va-list"),e=p("app-layout");return S(),U(e,{busy:a.busy},{default:_(()=>[c("div",null,[u(g,{title:"Chats"})]),c("div",at,[c("div",it,[u(L,null,{default:_(()=>[u(m,{class:"mb-3"},{default:_(()=>[R(" Contacts ")]),_:1}),(S(!0),M(q,null,O(a.users,(o,n)=>(S(),U(E,{class:G({list__item:!0,active:o.active}),key:n,disabled:!1,onClick:v=>a.chatHistory(o)},{default:_(()=>[u(b,{avatar:""},{default:_(()=>[u(d,{dot:"",color:o.isOnline?"success":"secondary"},{default:_(()=>[u(f,{size:"small"})]),_:2},1032,["color"])]),_:2},1024),u(b,null,{default:_(()=>[u(C,null,{default:_(()=>[c("b",null,B(o.name),1)]),_:2},1024),u(C,null,{default:_(()=>[c("small",null,B(o.position),1)]),_:2},1024),u(C,{caption:""},{default:_(()=>[R(B(o.lastMessage),1)]),_:2},1024)]),_:2},1024),u(b,{icon:""},{default:_(()=>[u(w,{name:"remove_red_eye",color:"background-tertiary"})]),_:1})]),_:2},1032,["class","onClick"]))),128))]),_:1})]),c("div",nt,[a.currentUser?(S(),M("div",lt,[c("div",ct,[c("div",rt,B(a.currentUser.name),1),c("div",ht,B(a.currentUser.position),1)])])):K("",!0),c("div",dt,[c("div",ut,[c("button",null,[u(w,{name:"attach_file"})])]),P(c("input",{class:"text-input",type:"text","onUpdate:modelValue":t[0]||(t[0]=o=>a.text=o),onKeyup:t[1]||(t[1]=Z((...o)=>a.send&&a.send(...o),["enter"]))},null,544),[[W,a.text]]),c("button",{onClick:t[2]||(t[2]=(...o)=>a.send&&a.send(...o))},"Send")])])])]),_:1},8,["busy"])}const vt=z(ot,[["render",mt]]);export{vt as default};
