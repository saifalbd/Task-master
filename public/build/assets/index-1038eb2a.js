import{B as D,_ as q,e as K,m as P,r as k,f as W,g as F,h as v,i as x,o as B,a as n,j as m,b as V,c as U,k as Z,F as G,q as M,t as E,s as N,w as J,v as Q,P as X}from"./app-e8ae732e.js";import{A as Y,_ as $,c as tt}from"./PageTitleBox-04038783.js";import{e as i,m as g,u as et,i as y}from"./icon-c404ea0d.js";class j{constructor(t){this.chat=t,this.isSend=t.isSend,this.isHover=!1;let o=i("span",`${this.isSend?"Send":"Recieve"}: ${t.message}`);this.chatRow=i(".chat-row",{},[this.fileBox(t),o]),this.el=i("li",{},[this.chatRow]),this.isSend&&this.el.classList.add("right")}fileBox(t){if(t.attach){let o=t.attach;return o.isImg?i("img",{src:t.attach.url}):i("a",{href:o.url},`${o.url}`)}else return i("span")}onmount(){const{id:t,is_view:o,message:s}=this.chat;window.Echo.private(`chatread.${t}`).listen("ChatReadEvent",r=>{let h=this.chatRow.querySelector(".chat-row-icon");h&&h.remove(),g(this.chatRow,i("span",{class:"chat-row-icon"},[y.create(y.dobbleCheck,18)]))}),this.isSend?o!=null&&(o?g(this.chatRow,i("span",{class:"chat-row-icon"},[y.create(y.dobbleCheck,18)])):g(this.chatRow,i("span",{class:"chat-row-icon"},[y.create(y.check,18)]))):this.el.addEventListener("mouseover",()=>{this.isHover||(o||window.axios.put(route("chat.read",{chat:t}),{}),this.isHover=!0)})}}class st{constructor(){this.el=i("ul",{class:"chat-content"}),this.list=[]}pushCollection(t){t.forEach(o=>{let s=new j(o);this.list.push(s),g(this.el,s)})}push(t){let o=new j(t);this.list.push(o),g(this.el,o)}removeCollection(){this.list.forEach(t=>{et(this.el,t)})}scrollToBottom(){let t=this.list.at(-1);t&&t.el.scrollIntoView()}}class ot{constructor(t,o,s,r,h){this.parentDom=t,this.src=o,this.file=s,this.captionText="",this.callBack=r,this.isImg=h,this.attachIcon="M16.61 13.5C15.81 13.85 15.11 14.36 14.54 15H9.5C8.12 15 7 13.88 7 12.5S8.12 10 9.5 10H17V11.5H9.5C8.95 11.5 8.5 11.95 8.5 12.5S8.95 13.5 9.5 13.5H16.61M3.5 12.5C3.5 10.29 5.29 8.5 7.5 8.5H18C19.38 8.5 20.5 9.62 20.5 11C20.5 11.84 20.08 12.58 19.45 13.03C20.05 13.07 20.63 13.2 21.17 13.41C21.69 12.74 22 11.91 22 11C22 8.79 20.21 7 18 7H7.5C4.46 7 2 9.46 2 12.5S4.46 18 7.5 18H13.09C13.18 17.47 13.34 16.97 13.55 16.5H7.5C5.29 16.5 3.5 14.71 3.5 12.5M21.34 15.84L17.75 19.43L16.16 17.84L15 19L17.75 22L22.5 17.25L21.34 15.84Z",this.el=i(".attach-model",{},[i(".attach-card",{},[this.close(),this.file_box(),this.captionBox(),this.sendBox()])])}close(){let t=i("div",{class:"close-box"},[y.create(y.close)]);return t.addEventListener("click",()=>{this.el.remove()}),t}file_box(){let t=i("div",{},[i("div",{style:`height: 100px;
                width: 100px;
                display: flex;
                justify-content: center;
                align-items: center;`},[y.create(this.attachIcon,50)]),i("p",{},this.src),i("div",{},`Size:${this.file.size}`)]),o=this.isImg?i("img",{src:this.src}):t;return i(".file_box",{},[o])}captionBox(){let t=i("input",{placeholder:"Caption"});return t.addEventListener("change",o=>{let s=t.value;this.captionText=s}),i("div",{class:"caption-box"},[t])}sendBox(){let t=i("button","send");return t.addEventListener("click",()=>{const o=this.captionText;this.callBack(o,this.file),this.el.remove()}),i(".send-box",{},[t])}}const z=(d,t,o,s)=>{let r=document.getElementById("chatMainBar");g(r,new ot(r,d,t,o,s))},it=d=>{let t=d.type;return console.log({type:t}),D.startsWith(t,"image")},nt=(d,t)=>{try{let s=d.target.files;if(s.length){let r=s[0],h=it(r);console.log({isImg:h});const C=document.getElementById("attachBox"),S=A(t);if(C.removeChild(C.querySelector("input")),setTimeout(()=>{g(C,S)},3e3),h){let f=new FileReader;f.onload=function(){let L=f.result;z(L,r,t,h)},f.readAsDataURL(r)}else z(r.name,r,t,h)}}catch(o){console.error(o)}},A=d=>{let t=i("input",{class:"attach-input",type:"file"},[]);return t.addEventListener("change",o=>{nt(o,d)}),t},at={components:{AppLayout:Y,PageTitleBox:$},setup(){const d=tt(),t=K(d.users),o=P(),s=k(!1),r=k(!1),h=Echo.join("chat").joining(e=>{axios.put(route("online",{user:e.id}))}).leaving(e=>{axios.put(route("offline",{user:e.id}),{})});(()=>{try{h.listen("UserOnline",e=>{l(e.id,1)}).listen("UserOffline",e=>{l(e.id,0)}).listenForWhisper("typing",e=>{let c=e.user;u.value.id==c&&(r.value=e.typing)}).listen("ChatEvent",e=>{const c=e.sender_id,a=u.value.id;if(console.log({sender_id:c,current_id:a,auth_id:f}),c!=f)if(a==c){let p=w(e);_.push(p),_.scrollToBottom()}else d.increaseUnread(e.sender_id,1)})}catch(e){console.error(e)}})();const S=e=>{console.log({typing:e}),h.whisper("typing",{user:f,typing:e})},f=o.auth_id,L=k(!1),u=k(null),b=k(""),_=new st,w=e=>{const{sender_id:c,receiver_id:a}=e;return f==c?e.isSend=!0:e.isSend=!1,e},H=async()=>{let e=D.trim(b.value);s.value=!0;try{if(!e)throw"message are Empty";if(!u)throw"current user not found";const c=route("chat.store"),{data:a}=await axios.post(c,{receiver_id:u.value.id,message:e});_.push(w(a)),_.scrollToBottom(),b.value=""}catch(c){console.error(c)}s.value=!1},T=async e=>{let c=u.value;if(r.value=!1,c&&c.id==e.id)return null;_.removeCollection(),u.value=e,t.forEach(a=>a.active=!1),e.active=!0;try{const a=route("chat.index",{receiver_id:e.id}),{data:p}=await axios.get(a);let R=p.map(O=>w(O));g(document.getElementById("chatMainBar"),_),_.pushCollection(R),_.scrollToBottom()}catch(a){console.error(a)}},l=(e,c)=>{const a=t.find(p=>p.id==e);a&&(a.isOnline=!!c)},I=async(e,c)=>{try{if(!u.value)throw new Error("CurrentUser Not Found");const a=route("chat.store"),p=new FormData;p.append("message",e),p.append("receiver_id",u.value.id),p.append("file",c);const{data:R}=await axios.post(a,p);_.push(w(R)),_.scrollToBottom()}catch(a){console.error(a)}};return W(()=>{let e=D.head(t);e&&T(e),g(document.getElementById("attachBox"),A(I))}),{busy:L,sendBusy:s,users:t,currentUser:u,chatHistory:T,text:b,send:H,typing:r,isTyping:S}}},lt={class:"chat-layout full-screen"},ct={class:"chat-side-bar"},rt={class:"chat-main-bar",id:"chatMainBar"},dt={key:0,class:"current-info"},ht={class:"left"},ut={key:0,class:"avatar-box"},_t=["src"],mt={class:"name"},vt={class:"position"},ft={class:"input-box-layout"},pt={key:0},xt={class:"attach-box",id:"attachBox"},yt=n("div",{class:"input-loader"},"loading ...",-1);function gt(d,t,o,s,r,h){const C=x("page-title-box"),S=x("va-list-label"),f=x("va-avatar"),L=x("va-badge"),u=x("va-list-item-section"),b=x("va-list-item-label"),_=x("va-list-item"),w=x("va-list"),H=x("va-icon"),T=x("app-layout");return B(),F(T,{busy:s.busy},{default:v(()=>[n("div",null,[m(C,{title:"Chats"})]),n("div",lt,[n("div",ct,[m(w,null,{default:v(()=>[m(S,{class:"mb-3"},{default:v(()=>[V(" Contacts ")]),_:1}),(B(!0),U(G,null,Z(s.users,(l,I)=>(B(),F(_,{class:N({list__item:!0,active:l.active}),key:I,disabled:!1,onClick:e=>s.chatHistory(l)},{default:v(()=>[m(u,{avatar:""},{default:v(()=>[m(L,{dot:"",color:l.isOnline?"success":"secondary"},{default:v(()=>[m(f,{size:"small"})]),_:2},1032,["color"])]),_:2},1024),m(u,null,{default:v(()=>[m(b,null,{default:v(()=>[n("b",null,E(l.name),1)]),_:2},1024),m(b,null,{default:v(()=>[n("small",null,E(l.position),1)]),_:2},1024),m(b,{caption:""},{default:v(()=>[V(E(l.lastMessage),1)]),_:2},1024)]),_:2},1024),m(u,{icon:""},{default:v(()=>[n("b",null,E(l.unReadCount),1)]),_:2},1024)]),_:2},1032,["class","onClick"]))),128))]),_:1})]),n("div",rt,[s.currentUser?(B(),U("div",dt,[n("div",ht,[s.currentUser.avatar?(B(),U("div",ut,[n("img",{src:s.currentUser.avatar.url,alt:"",srcset:""},null,8,_t)])):M("",!0),n("div",null,[n("div",mt,E(s.currentUser.name),1),n("div",vt,E(s.currentUser.position),1)])])])):M("",!0),n("div",ft,[n("small",null,[s.typing?(B(),U("b",pt,"typing...")):M("",!0)]),n("div",{class:N(["input-box",{busy:s.sendBusy}])},[n("div",xt,[n("button",null,[m(H,{name:"attach_file"})])]),J(n("input",{class:"text-input",type:"text","onUpdate:modelValue":t[0]||(t[0]=l=>s.text=l),onFocus:t[1]||(t[1]=l=>s.isTyping(!0)),onBlur:t[2]||(t[2]=l=>s.isTyping(!1)),onKeyup:t[3]||(t[3]=X((...l)=>s.send&&s.send(...l),["enter"]))},null,544),[[Q,s.text]]),n("button",{onClick:t[4]||(t[4]=(...l)=>s.send&&s.send(...l))},"Send"),yt],2)])])])]),_:1},8,["busy"])}const Bt=q(at,[["render",gt]]);export{Bt as default};
